name: Run DRAM Scraper

on:
  schedule:
    - cron: "0 6/4 * * *"  # â° every 4 hours
  workflow_dispatch:        # allow manual trigger

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
    
      # Installs Chromium and its matching driver to prevent Selenium crashes.
      - name: Install Chromium and Driver
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
    
      - name: Install dependencies
        run: pip install -r trendforce_update/requirements.txt
    
      - name: Run scraper
        run: python trendforce_update/main.py
    
      # Checks if the CSV file was modified by the Python script.
      - name: Check for changes
        id: git_status
        run: |
          if [[ $(git status --porcelain=v1 | grep "dram_price_history_FULL.csv") ]]; then
            echo "files_changed=true" >> $GITHUB_OUTPUT
          else
            echo "files_changed=false" >> $GITHUB_OUTPUT
          fi
    
      # Configures Git user and commits/pushes ONLY if the file was modified.
      - name: Commit and Push CSV
        if: steps.git_status.outputs.files_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dram_price_history_FULL.csv
          COMMIT_MESSAGE="Automated data update: DRAM prices (${{ github.run_number }})"
          git commit -m "$COMMIT_MESSAGE"
          git push
